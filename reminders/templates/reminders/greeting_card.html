<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interactive Greeting Card for {{ event.name }}">
  <title>{{ event.name }} - Greeting Card</title>
  <link rel="stylesheet" href="{% static 'css/greeting_card.css' %}">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="min-h-screen flex items-center justify-center p-4 font-sans overflow-hidden">
  <!-- Raksha Bandhan Loading Screen -->
  {% if event.event_type == 'raksha_bandhan' %}
  <div class="rakhi-loading" id="rakhi-loading">
    <div class="rangoli-pattern">
      <div class="rangoli-circle"></div>
      <div class="rangoli-circle"></div>
      <div class="rangoli-circle"></div>
    </div>
    <div class="loading-text">आपकी पवित्र यात्रा शुरू हो रही है...<br><small>Your sacred journey is beginning...</small></div>
    <div class="progress-garland">
      <div class="progress-fill"></div>
    </div>
  </div>
  {% endif %}
  <!-- Background Elements -->
  <div class="background-effects">
    <div class="stars-container"></div>
    <div class="clouds-container"></div>

    <!-- Raksha Bandhan Specific Background -->
    {% if event.event_type == 'raksha_bandhan' %}
    <div class="floating-petals">
      <!-- Petals will be dynamically generated -->
    </div>

    <div class="sacred-pattern top-left">🕉️</div>
    <div class="sacred-pattern top-right">🪔</div>
    <div class="sacred-pattern bottom-left">🌸</div>
    <div class="sacred-pattern bottom-right">🕉️</div>
    {% endif %}
  </div>

  <!-- Theme Toggle Button -->
  <div class="theme-toggle-container">
    <button class="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false">
      <div class="toggle-track">
        <div class="toggle-thumb">
          <div class="sun-icon">
            <div class="sun-rays"></div>
            <div class="sun-core"></div>
          </div>
          <div class="moon-icon">
            <div class="moon-body"></div>
            <div class="moon-crater crater-1"></div>
            <div class="moon-crater crater-2"></div>
            <div class="moon-crater crater-3"></div>
          </div>
        </div>
      </div>
    </button>
  </div>

  <!-- Vertical Navigation Sidebar -->
  <nav class="page-navigator" role="navigation" aria-label="Card Pages Navigation">
    <div class="nav-item active" data-page="1" tabindex="0" role="button" aria-label="Welcome Page">
      <i class="fas fa-home"></i>
      <span class="nav-tooltip">
        {% if event.event_type == 'raksha_bandhan' %}Sacred Bond{% else %}Welcome{% endif %}
      </span>
    </div>
    <div class="nav-item" data-page="2" tabindex="0" role="button" aria-label="Ritual Page">
      <i class="{% if event.event_type == 'raksha_bandhan' %}fas fa-hand-holding-heart{% else %}fas fa-play-circle{% endif %}"></i>
      <span class="nav-tooltip">
        {% if event.event_type == 'raksha_bandhan' %}Sacred Ritual{% else %}Animation{% endif %}
      </span>
    </div>
    <div class="nav-item" data-page="3" tabindex="0" role="button" aria-label="Memories Page">
      <i class="fas fa-camera"></i>
      <span class="nav-tooltip">
        {% if event.event_type == 'raksha_bandhan' %}Bachpan Ki Yaadein{% else %}Memories{% endif %}
      </span>
    </div>
    <div class="nav-item" data-page="4" tabindex="0" role="button" aria-label="Blessings Page">
      <i class="{% if event.event_type == 'raksha_bandhan' %}fas fa-praying-hands{% else %}fas fa-magic{% endif %}"></i>
      <span class="nav-tooltip">
        {% if event.event_type == 'raksha_bandhan' %}Blessings{% else %}Interactive{% endif %}
      </span>
    </div>
    <div class="nav-item" data-page="5" tabindex="0" role="button" aria-label="Eternal Bond Page">
      <i class="fas fa-heart"></i>
      <span class="nav-tooltip">
        {% if event.event_type == 'raksha_bandhan' %}Eternal Bond{% else %}Farewell{% endif %}
      </span>
    </div>
  </nav>

  {% if error %}
  <div class="error-alert" role="alert">
    {{ error }}
  </div>
  {% endif %}

  <!-- Main Card Container -->
  <div class="card-container"
       data-theme="{{ event.event_type }}"
       data-cultural-theme="{{ event.cultural_theme|yesno:'true,false' }}"
       data-recipient-name="{{ recipient_name }}"
       data-custom-label="{{ event.custom_label|default:'' }}"
       data-event-id="{{ event.id }}"
       data-thread-of-memories="{{ has_thread_of_memories|yesno:'true,false' }}"
       data-memories="{{ thread_of_memories_data }}"
       data-audio-url="{% for media in event.media.all %}{% if media.media_type == 'audio' %}{{ media.media_file|urlencode }}{% endif %}{% endfor %}">



    <!-- Enhanced Diya Decorations for Rakhi -->
    {% if event.event_type == 'raksha_bandhan' %}
    <div class="rakhi-diya-decorations">
      <div class="rakhi-diya top-left">
        <div class="rakhi-diya-base"></div>
        <div class="rakhi-diya-flame"></div>
      </div>
      <div class="rakhi-diya top-right">
        <div class="rakhi-diya-base"></div>
        <div class="rakhi-diya-flame"></div>
      </div>
      <div class="rakhi-diya bottom-left">
        <div class="rakhi-diya-base"></div>
        <div class="rakhi-diya-flame"></div>
      </div>
      <div class="rakhi-diya bottom-right">
        <div class="rakhi-diya-base"></div>
        <div class="rakhi-diya-flame"></div>
      </div>
    </div>
    {% else %}

    <!-- Original CSS Tree Growth Animation for other themes -->
    <div class="tree-animation">
      <div class="tree-trunk"></div>
      <div class="tree-leaves"></div>
      <div class="tree-flowers"></div>
    </div>

    <!-- CSS Diya Decorations -->
    <div class="diya-decorations">
      <div class="diya top-left">
        <div class="diya-base"></div>
        <div class="diya-flame"></div>
      </div>
      <div class="diya top-right">
        <div class="diya-base"></div>
        <div class="diya-flame"></div>
      </div>
      <div class="diya bottom-left">
        <div class="diya-base"></div>
        <div class="diya-flame"></div>
      </div>
      <div class="diya bottom-right">
        <div class="diya-base"></div>
        <div class="diya-flame"></div>
      </div>
    </div>
    {% endif %}

    <!-- Card Pages -->
    <div class="card-pages">
      <!-- Page 1: Welcome / Password -->
      <div class="card-page {% if not requires_card_password %}active{% endif %}" id="page-1" role="tabpanel" aria-labelledby="nav-1">
        <div class="page-content">
          <h2 class="welcome-title" data-event-type="{{ event.event_type }}">
            {% if event.event_type == 'raksha_bandhan' %}
            🌸 A Sacred Bond Awaits 🌸<br>
            💝 Surprise for <span class="recipient-name">{{ event.name }}</span>!<br>
            ✨ Raksha Bandhan Ki Shubhkamnayein ✨
            {% elif event.event_type == 'birthday' %}
            ✨ A Special Surprise Awaits ✨<br>
            🎉 Surprise for <span class="recipient-name">{{ event.name }}</span>!
            {% elif event.event_type == 'anniversary' %}
            💞 A Love Note for <span class="recipient-name">{{ event.name }}</span>
            {% else %}
            ✨ A Special Message for <span class="recipient-name">{{ event.name }}</span>
            {% endif %}
          </h2>

          <div class="puzzle-container">
            {% if event.event_type == 'raksha_bandhan' %}
            <div class="rakhi-puzzle">
              <div class="rakhi-puzzle-text">What sacred thread binds siblings forever?</div>
              <div class="rakhi-hint">💝 The thread that weaves hearts together with love and protection</div>
            </div>
            {% elif event.event_type == 'birthday' %}
            <div class="emoji-puzzle">🎉 + 💝 = Pure Joy!</div>
            {% elif event.event_type == 'anniversary' %}
            <div class="date-puzzle">What is the date that marks another year of our journey together?</div>
            {% else %}
            <div class="emoji-puzzle">✈️😢 = ?</div>
            {% endif %}
          </div>

          {% if requires_card_password %}
          <div class="password-container">
            <form method="post" action="{% url 'validate_card_password' event.id %}">
              {% csrf_token %}
              <div class="input-group">
                <label for="card-password-input" class="sr-only">Card Password</label>
                <input type="password"
                    id="card-password-input"
                    name="card_password"
                    class="password-input"
                    placeholder="{% if event.event_type == 'raksha_bandhan' %}Enter the sacred thread name...{% else %}Enter the card password...{% endif %}"
                    aria-required="true">
                <button type="submit" class="unlock-button" aria-label="Unlock card content">
                  <i class="fas fa-unlock"></i>
                  Unlock
                </button>
              </div>
            </form>

            <div class="password-hint" aria-live="polite">
              <span class="hint-icon">💡</span>
              Hint:
              {% if event.event_type == 'raksha_bandhan' %}
              The <strong>symbol</strong> of our bond (e.g., rakhi, thread, or bond).
              {% elif event.event_type == 'birthday' %}
              <strong>The name</strong> that brings smiles every year.
              {% elif event.event_type == 'anniversary' %}
              When did <strong>we</strong> begin this journey?
              {% else %}
              The one <strong>word</strong> that defines this memory
              {% endif %}
            </div>

            <div class="password-hint {% if not error %}hidden{% endif %}" id="password-hint">
              <strong>Can't crack it?</strong> Here's something that might help:
              <span id="reveal-password" class="reveal-button" tabindex="0" role="button" aria-label="Reveal password">Click to reveal password</span>
            </div>
            <span id="actual-password" class="hidden">{{ password_text }}</span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Page 2: Animation/Countdown -->
      <div class="card-page" id="page-2" role="tabpanel" aria-labelledby="nav-2">
        <div class="page-content">
          {% if event.event_type == 'raksha_bandhan' %}
          <h2 class="page-title">Ready for the sacred ritual, <span class="recipient-name">{{ event.name }}</span>?</h2>
          <p class="ritual-subtitle">Let's celebrate our eternal bond!</p>

           <div class="rakhi-ceremony-svg-container">
                <svg width="100%" height="400" viewBox="0 0 800 400" class="rakhi-ceremony-svg">
                    <!-- Background Elements -->
                    <defs>
                        <radialGradient id="petalGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" stop-color="#FFB347" stop-opacity="0.8"/>
                            <stop offset="100%" stop-color="#FF6B35" stop-opacity="0.4"/>
                        </radialGradient>
                        <linearGradient id="floorGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#8B4513" stop-opacity="0.3"/>
                            <stop offset="100%" stop-color="#A0522D" stop-opacity="0.2"/>
                        </linearGradient>
                    </defs>

                    <!-- Floor/Mat -->
                    <ellipse cx="400" cy="380" rx="350" ry="30" fill="url(#floorGradient)" opacity="0.6"/>

                    <!-- Floating Background Petals -->
                    <g class="bg-petals">
                        <circle cx="100" cy="80" r="4" fill="url(#petalGradient)" class="floating-petal">
                            <animateTransform attributeName="transform" attributeType="XML" type="translate"
                                values="0,0; 20,-10; 0,0" dur="4s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="700" cy="120" r="3" fill="url(#petalGradient)" class="floating-petal">
                            <animateTransform attributeName="transform" attributeType="XML" type="translate"
                                values="0,0; -15,8; 0,0" dur="5s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="150" cy="200" r="5" fill="url(#petalGradient)" class="floating-petal">
                            <animateTransform attributeName="transform" attributeType="XML" type="translate"
                                values="0,0; 10,15; 0,0" dur="3.5s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="650" cy="250" r="4" fill="url(#petalGradient)" class="floating-petal">
                            <animateTransform attributeName="transform" attributeType="XML" type="translate"
                                values="0,0; -20,-5; 0,0" dur="4.5s" repeatCount="indefinite"/>
                        </circle>
                    </g>

                    <!-- Sister Character -->
                    <g id="sister" transform="translate(50, 180)">
                        <!-- Sister's Body -->
                        <g class="sister-body">
                            <!-- Lehenga Skirt -->
                            <path d="M 0 120 Q -30 140 -25 180 L 25 180 Q 30 140 0 120"
                                  fill="#E91E63" stroke="#C2185B" stroke-width="2"/>
                            <!-- Lehenga Design -->
                            <circle cx="-10" cy="160" r="3" fill="#FFD700" opacity="0.8"/>
                            <circle cx="10" cy="150" r="3" fill="#FFD700" opacity="0.8"/>

                            <!-- Choli/Blouse -->
                            <rect x="-12" y="100" width="24" height="25" rx="5"
                                  fill="#8E24AA" stroke="#7B1FA2" stroke-width="1"/>

                            <!-- Arms -->
                            <ellipse cx="-18" cy="105" rx="4" ry="15" fill="#FFDBCB"/>
                            <ellipse cx="18" cy="105" rx="4" ry="15" fill="#FFDBCB" class="sister-right-arm"/>

                            <!-- Hands -->
                            <circle cx="-22" cy="120" r="5" fill="#FFDBCB"/>
                            <circle cx="25" cy="115" r="5" fill="#FFDBCB" class="sister-right-hand"/>

                            <!-- Head -->
                            <circle cx="0" cy="85" r="18" fill="#FFDBCB"/>

                            <!-- Hair -->
                            <path d="M -18 75 Q -20 65 -10 70 Q 0 60 10 70 Q 20 65 18 75 Q 15 90 0 85 Q -15 90 -18 75"
                                  fill="#4A2C2A"/>

                            <!-- Face Features -->
                            <!-- Eyes -->
                            <ellipse cx="-6" cy="82" rx="2" ry="1" fill="black"/>
                            <ellipse cx="6" cy="82" rx="2" ry="1" fill="black"/>
                            <!-- Smile -->
                            <path d="M -4 90 Q 0 95 4 90" stroke="black" stroke-width="1" fill="none"/>
                            <!-- Bindi -->
                            <circle cx="0" cy="78" r="2" fill="#DC143C"/>

                            <!-- Dupatta -->
                            <path d="M -15 95 Q -25 85 -20 75 L -10 80 Q -5 85 -15 95"
                                  fill="#FF5722" opacity="0.7"/>
                        </g>
                    </g>

                    <!-- Brother Character -->
                    <g id="brother" transform="translate(500, 200)">
                        <!-- Brother's Body (Sitting Cross-legged) -->
                        <g class="brother-body">
                            <!-- Legs (Cross-legged) -->
                            <ellipse cx="-20" cy="140" rx="25" ry="8" fill="#3F51B5" transform="rotate(-10)"/>
                            <ellipse cx="20" cy="140" rx="25" ry="8" fill="#3F51B5" transform="rotate(10)"/>

                            <!-- Kurta -->
                            <rect x="-20" y="80" width="40" height="60" rx="8"
                                  fill="#4CAF50" stroke="#388E3C" stroke-width="2"/>
                            <!-- Kurta Design -->
                            <line x1="-15" y1="90" x2="15" y2="90" stroke="#FFD700" stroke-width="2"/>
                            <line x1="-10" y1="100" x2="10" y2="100" stroke="#FFD700" stroke-width="1"/>

                            <!-- Arms -->
                            <ellipse cx="-25" cy="90" rx="6" ry="18" fill="#FFDBCB"/>
                            <ellipse cx="25" cy="90" rx="6" ry="18" fill="#FFDBCB" class="brother-left-arm"/>

                            <!-- Hands -->
                            <circle cx="-35" cy="110" r="6" fill="#FFDBCB" class="brother-right-hand"/>
                            <circle cx="35" cy="110" r="6" fill="#FFDBCB" class="brother-left-hand"/>

                            <!-- Head -->
                            <circle cx="0" cy="60" r="20" fill="#FFDBCB"/>

                            <!-- Hair -->
                            <path d="M -20 50 Q -18 35 0 40 Q 18 35 20 50 Q 15 65 0 60 Q -15 65 -20 50"
                                  fill="#2E2E2E"/>

                            <!-- Face Features -->
                            <!-- Eyes -->
                            <ellipse cx="-7" cy="57" rx="2.5" ry="1.5" fill="black"/>
                            <ellipse cx="7" cy="57" rx="2.5" ry="1.5" fill="black"/>
                            <!-- Smile -->
                            <path d="M -5 68 Q 0 73 5 68" stroke="black" stroke-width="1.5" fill="none"/>

                            <!-- Rakhi on Wrist (Initially Hidden) -->
                            <g id="wrist-rakhi" opacity="0" transform="translate(35, 110)">
                                <!-- Rakhi Thread around wrist -->
                                <ellipse cx="0" cy="0" rx="8" ry="3" fill="none" stroke="#FF6B35" stroke-width="2"/>
                                <!-- Main Rakhi Design -->
                                <circle cx="0" cy="-6" r="6" fill="#FFD700" stroke="#FF6B35" stroke-width="2"/>
                                <circle cx="0" cy="-6" r="3" fill="#DC143C"/>
                                <circle cx="-2" cy="-8" r="1" fill="#4CAF50"/>
                                <circle cx="2" cy="-8" r="1" fill="#2196F3"/>
                                <circle cx="0" cy="-4" r="1" fill="#FF9800"/>
                            </g>

                            <!-- Tilak on Forehead (Initially Hidden) -->
                            <g id="forehead-tilak" opacity="0" transform="translate(0, 45)">
                                <!-- Main tilak mark -->
                                <ellipse cx="0" cy="0" rx="2" ry="8" fill="#DC143C"/>
                                <ellipse cx="0" cy="0" rx="1" ry="6" fill="#FF4444"/>
                                <!-- Small dot at top -->
                                <circle cx="0" cy="-10" r="1.5" fill="#DC143C"/>
                            </g>
                        </g>
                    </g>
                </svg>

                <!-- Start Ritual Button -->
                <div class="ritual-controls" id="ritual-controls">
                    <button id="start-ritual-btn" class="action-button ritual-btn">
                        <i class="fas fa-play-circle"></i>
                        Start Sacred Ritual
                    </button>
                    <p class="ritual-instruction">Click to begin the beautiful ceremony</p>
                </div>
            </div>

            <!-- Beautiful CSS Rakhi Display -->
            <div class="beautiful-rakhi-container" id="beautiful-rakhi">
                <div class="rakhi-display">
                    <div class="css-rakhi">
                        <!-- Rakhi Thread Base -->
                        <div class="rakhi-thread"></div>
                        <!-- Decorative Rings -->
                        <div class="rakhi-outer-ring"></div>
                        <div class="rakhi-middle-ring"></div>
                        <div class="rakhi-inner-ring"></div>
                        <!-- Decorative Petals -->
                        <div class="rakhi-petals">
                            <div class="petal" style="--rotation: 0deg;"></div>
                            <div class="petal" style="--rotation: 45deg;"></div>
                            <div class="petal" style="--rotation: 90deg;"></div>
                            <div class="petal" style="--rotation: 135deg;"></div>
                            <div class="petal" style="--rotation: 180deg;"></div>
                            <div class="petal" style="--rotation: 225deg;"></div>
                            <div class="petal" style="--rotation: 270deg;"></div>
                            <div class="petal" style="--rotation: 315deg;"></div>
                        </div>
                        <!-- Decorative Gems -->
                        <div class="rakhi-gems">
                            <div class="gem"></div>
                            <div class="gem"></div>
                            <div class="gem"></div>
                            <div class="gem"></div>
                        </div>
                        <!-- Center Circle with Om -->
                        <div class="rakhi-center">
                            <div class="om-symbol">ॐ</div>
                        </div>
                    </div>
                    <div class="gift-icon" id="gift-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                </div>
                <button class="close-rakhi" id="close-rakhi">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Gift Popup -->
            <div class="gift-popup" id="gift-popup">
                <div class="gift-popup-content">
                    <h3>🎁 Happy Raksha Bandhan!</h3>
                    <p class="hindi-message">मेरी प्यारी बहना ❤️</p>
                    <p class="english-message">Enjoy this greeting card I made for you...</p>
                    <p class="playful-message">(🎁 उपहार दिल से है, जेब से नहीं 😅 | Gift is from the heart, not the wallet 😅)</p>
                    <button class="close-gift-popup" id="close-gift-popup">
                        <i class="fas fa-heart"></i> Thank You!
                    </button>
                </div>
            </div>

          {% elif event.event_type == 'birthday' %}
          <h2 class="page-title">Want a gift, <span class="recipient-name">{{ event.name }}</span>?</h2>
          <div class="countdown-container">
            <div class="countdown" aria-live="assertive">5</div>
            <div class="countdown-hint" aria-live="polite">
              <span class="hint-icon">💡</span>
              <strong>Hint:</strong> Slide to unlock <b>"YES!"</b> to start the countdown!
            </div>
            <div class="slider-unlock-container">
              <div class="slider-track">
                <div class="slider-thumb" tabindex="0" aria-label="Slide to unlock Yes">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <span class="slider-label">Slide to unlock <b>YES!</b></span>
              </div>
            </div>
            <button id="yes-unlocked-button" class="action-button hidden" aria-label="Start countdown">
              <i class="fas fa-gift"></i>
              YES!
            </button>
          </div>
          {% elif event.event_type == 'anniversary' %}
          <h2 class="page-title">Our Journey Together</h2>
          <div class="clock-container">
            <div class="anniversary-clock" aria-label="Anniversary clock showing our journey"></div>
            <div class="milestone-text" aria-live="polite">{{ highlights|linebreaksbr }}</div>
            <div class="milestone-text">Every moment with you is special.</div>
          </div>
          {% else %}
          <h2 class="page-title">Inspiration for You</h2>
          <div class="quote-container">
            <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Page 3: Memory/Media -->
      <div class="card-page" id="page-3" role="tabpanel" aria-labelledby="nav-3">
        <div class="page-content">
          <h2 class="page-title">
            {% if event.event_type == 'raksha_bandhan' %}
            Rakhi Recap<br>
            <span style="font-size: 1.2rem; color: var(--rakhi-saffron);">Sibling Memories Through the Years</span>
            {% elif event.event_type == 'birthday' %}Memory Snapshot
            {% elif event.event_type == 'anniversary' %}Our Story
            {% else %}Special Moments
            {% endif %}
          </h2>

          <div class="media-container">
            {% if event.event_type == 'raksha_bandhan' %}
            <div class="photo-gallery">
              <div class="photo-frame">
                <div class="media-display"
                     data-media-urls="{% for media in event.media.all %}{% if media.media_type == 'image' %}{{ media.media_file|urlencode }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}"
                     data-fallback-url="{% static 'images/nature.jpg' %}"
                     role="img"
                     aria-label="Raksha Bandhan celebration">
                </div>
                <div class="marigold-decoration" style="position: absolute; top: 10px; right: 10px; font-size: 2rem; z-index: 2;">🌼</div>
                <div class="photo-caption" style="text-align: center; margin-top: 15px; color: var(--rakhi-gold);">
                  {% if event.media.exists %}
                  {{ event.media.first.caption|default:"Some special moments" }}
                  {% else %}
                  A moment inspired by nature
                  {% endif %}
                </div>
              </div>
            </div>
            {% else %}
            <div class="media-display"
                 data-media-urls="{% for media in event.media.all %}{% if media.media_type == 'image' %}{{ media.media_file|urlencode }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}"
                 data-fallback-url="{% static 'images/nature.jpg' %}"
                 tabindex="0">
            </div>
            <div class="media-caption">
              {% if event.media.exists %}
              {{ event.media.first.caption|default:"Some special moments" }}
              {% else %}
              A moment inspired by nature
              {% endif %}
            </div>
            {% endif %}


            <audio id="calming-sound" loop>
              <source src="{% static 'audio/Whispering Wind.mp3' %}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <button class="audio-control" aria-label="Toggle calming sound">
              <i class="fas fa-pause"></i>
              Pause Sound
            </button>
          </div>
        </div>
      </div>

      <!-- Page 4: Interactive Element -->
      <div class="card-page" id="page-4" role="tabpanel" aria-labelledby="nav-4">
        <div class="page-content">
          <h2 class="page-title">
            {% if event.event_type == 'raksha_bandhan' %}
            Blessings & Promises 🙏
            {% elif event.event_type == 'birthday' %}Make a Wish!
            {% elif event.event_type == 'anniversary' %}One More Dance?
            {% else %}Tree of Memories
            {% endif %}
          </h2>

          {% if event.event_type == 'raksha_bandhan' %}
          <!-- Sacred Promise Tree -->
          <div class="promise-tree-container">
            <div id="promise-tree" class="promise-tree" tabindex="0" aria-label="Sacred promise tree. Click to add promises.">
              <div class="tree-trunk"></div>
              <div class="tree-foliage"></div>
              <div class="tree-branches"></div>
            </div>
            <div class="tree-instruction" aria-live="polite">Click to plant a promise of support</div>
          </div>

          <!-- Blessing Shower -->
          <div style="text-align: center; margin: 30px 0;">
            <p style="color: var(--rakhi-primary); margin-bottom: 15px;">Shower blessings for prosperity</p>
            <button id="blessing-shower-btn" class="action-button" style="background: var(--rakhi-silk); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer;">
              <i class="fas fa-hands"></i>
              Send Blessings
            </button>
            <div id="blessing-shower" class="blessing-shower"></div>
          </div>

          <!-- Diya Lighting Ceremony -->
          <div class="diya-ceremony-container" id="diya-ceremony">
            <div class="ceremony-diya" data-wish="prosperity, समृद्धि">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
            <div class="ceremony-diya" data-wish="happiness, खुशी">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
            <div class="ceremony-diya" data-wish="health, स्वास्थ्य">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
            <div class="ceremony-diya" data-wish="success, सफलता">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
            <div class="ceremony-diya" data-wish="peace, शांति">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
            <div class="ceremony-diya" data-wish="love, प्यार">
              <div class="ceremony-diya-base"></div>
              <div class="ceremony-diya-flame"></div>
            </div>
          </div>
          <p style="text-align: center; color: var(--rakhi-saffron); margin-top: 15px;">Click each diya to light it with a blessing</p>

          {% elif event.event_type == 'birthday' %}
          <div class="cake-container">
            <div class="birthday-cake" tabindex="0" aria-label="Birthday cake with candles. Click to blow out candles.">
              <div class="cake-base"></div>
              <div class="cake-layers"></div>
              <div class="candles-container"></div>
            </div>
            <div class="cake-instruction" aria-live="polite">Click to blow out the candles!</div>
          </div>
          {% elif event.event_type == 'anniversary' %}
          <div class="dance-container">
            <button class="dance-button" aria-label="Start dance animation">
              <i class="fas fa-music"></i>
              Dance!
            </button>
            <div class="dance-animation" aria-live="polite"></div>
          </div>
          {% else %}
          <div class="memory-tree-container">
            <div class="memory-tree" tabindex="0" aria-label="Interactive memory tree. Click to add memories."></div>
            <div class="tree-instruction" aria-live="polite">Click to plant a memory</div>
            <div class="tree-message">
              {{ event.message|default:"Each click represents a moment we've shared." }}
            </div>
          </div>
          {% endif %}

          <!-- Audio Player Container -->
          <div class="audio-player-container" id="audio-player-container" {% if not audio_url %}style="display: none;"{% endif %}>
            <audio id="user-audio" aria-label="User-uploaded audio message" controls>
            {% if audio_url %}
            <source src="{{ audio_url }}" type="audio/mpeg">
            <source src="{{ audio_url }}" type="audio/flac">
            <source src="{{ audio_url }}" type="audio/wav">
            <source src="{{ audio_url }}" type="audio/ogg">
            <source src="{{ audio_url }}" type="audio/aac">
            {% endif %}
            <div class="audio-fallback" role="alert">
              Your browser does not support the audio element or the provided audio formats.
            </div>
            </audio>
            <button class="audio-control-btn" aria-label="Play special message">
              <i class="fas fa-play"></i>
              Play Special Message
            </button>
          </div>

          <!-- Fallback Quote -->
          <div class="quote-container fallback-quote" {% if audio_url %}style="display: none;"{% endif %}>
            <blockquote class="inspiration-quote" aria-live="polite"></blockquote>
          </div>
        </div>
      </div>

      <!-- Page 5: Farewell -->
      <div class="card-page" id="page-5" role="tabpanel" aria-labelledby="nav-5">
        <div class="page-content">
          {% if event.event_type == 'raksha_bandhan' %}
          <div class="eternal-bond-container">
            <div class="sanskrit-verse">
              राखी का यह पावन धागा,<br>
              बांधे प्रेम और विश्वास का नाता
            </div>
            <div class="verse-translation">
              This sacred thread of Rakhi,<br>
              Binds the bond of love and trust
            </div>

            <h2 class="page-title" style="margin: 30px 0;">
              <span class="recipient-name">{{ event.name }}</span>, you are my strength and joy!
            </h2>

            <div class="farewell-message" >
              {% if event.message %}
              {{ event.message|linebreaksbr }}
              {% else %}
              May our bond grow stronger with each passing year. You are not just my sibling, but my lifelong friend, protector, and companion. This sacred thread represents our unbreakable connection that transcends time and distance.
              {% endif %}
            </div>

            <!-- Sacred Thread Visualization -->
            <div class="infinity-thread">
              <svg width="200" height="100" viewBox="0 0 200 100">
                <path class="infinity-path" d="M 20 50 Q 50 20, 100 50 Q 150 80, 180 50 Q 150 20, 100 50 Q 50 80, 20 50" stroke="#F59E0B" stroke-width="4" fill="none"/>
              </svg>
            </div>

            <!-- Blessing Rain -->
            <div class="blessing-rain-container" id="blessing-rain">
              <!-- Animated blessings will be added here -->
            </div>
          </div>

          {% elif event.event_type == 'birthday' %}
          <h2 class="page-title">
            Happy Birthday, <span class="recipient-name">{{ event.name }}</span>!
          </h2>
          <div class="farewell-message">
            {% if event.message %}
            {{ event.message|linebreaksbr }}
            {% else %}
            Wishing you joy and happiness today and always.
            {% endif %}
          </div>
          {% elif event.event_type == 'anniversary' %}
          <h2 class="page-title">
            Here's to us, <span class="recipient-name">{{ event.name }}</span>. Forever yours.
          </h2>
          <div class="farewell-message">
            {% if event.message %}
            {{ event.message|linebreaksbr }}
            {% else %}
            Wishing you joy and happiness today and always.
            {% endif %}
          </div>
          {% else %}
          <h2 class="page-title">
            <span class="recipient-name">{{ event.name }}</span>, you're unforgettable.
          </h2>
          <div class="farewell-message">
            {% if event.message %}
            {{ event.message|linebreaksbr }}
            {% else %}
            Wishing you joy and happiness today and always.
            {% endif %}
          </div>
          {% endif %}

          {% if event.reflections.exists %}
          <div class="voice-note">
            <div class="voice-note-player">
              <button class="play-voice-note" aria-label="Play reflection note">
                <i class="fas fa-microphone"></i>
                Play Reflection
              </button>
              <div class="voice-note-text hidden" aria-live="polite">{{ event.reflections.first.note }}</div>
            </div>
          </div>
          {% endif %}
          <div class="final-animation" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Button and Modal -->
  <div class="card-footer">
    {% if is_owner %}
    <button class="share-card" data-event-id="{{ event.id }}" aria-label="Share card">
      <i class="fas fa-share-alt"></i>
      Share
    </button>
    {% endif %}
  </div>

  <!-- Share Modal -->
  <div class="share-modal" id="share-modal">
    <div class="share-modal-content">
      <h3>Share Your Card</h3>
      <p class="warning-text">Warning: This link will expire in 3 days.</p>
      <form id="share-form" onsubmit="return false;">
        {% csrf_token %}
        <div class="input-group">
          <input type="password" id="share-password" name="share_password"
                 placeholder="Set a share password (optional)..." aria-required="false">
          <div class="button-group">
            <button type="button" id="generate-share-link" aria-label="Generate share link">
              <i class="fas fa-link"></i>
              Generate Link
            </button>
            <button type="button" id="close-share-modal" aria-label="Close modal">
              <i class="fas fa-times"></i>
              Cancel
            </button>
          </div>
        </div>
      </form>
      <div class="share-url-container hidden" id="share-url-container">
        <p id="share-url"></p>
        <div class="social-links">
          <a id="whatsapp-share" href="#" target="_blank" aria-label="Share on WhatsApp">
            <i class="fab fa-whatsapp"></i>
            WhatsApp
          </a>
          <a id="twitter-share" href="#" target="_blank" aria-label="Share on Twitter">
            <i class="fab fa-twitter"></i>
            Twitter
          </a>
          <a id="email-share" href="#" aria-label="Share via Email">
            <i class="fas fa-envelope"></i>
            Email
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.cookie = "csrftoken={{ csrf_token }}; path=/";
  </script>
  <script src="{% static 'js/greeting_card.js' %}"></script>

</body>
</html>